<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bar Chart Race Animation</title>
    <!-- Add D3.js library -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script type="text/javascript" src="./enigmes.json"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .chart-race-container {
            margin: 20px auto;
            max-width: 960px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            padding: 20px;
            position: relative;
        }
        
        .chart-title {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }
        
        .riddle-display {
            font-size: 28px;
            font-weight: bold;
            opacity: 0.7;
            position: absolute;
            top: 20px;
            right: 30px;
            color: #555;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }
        
        .bar-label {
            font-weight: bold;
            fill: white;
            text-shadow: 1px 1px 1px rgba(0,0,0,0.5);
            dominant-baseline: middle;
        }
        
        .bar-score {
            font-weight: bold;
            fill: white;
            text-shadow: 1px 1px 1px rgba(0,0,0,0.5);
            text-anchor: end;
            dominant-baseline: middle;
        }
        
        .controls {
            text-align: center;
            margin-top: 20px;
        }
        
        button {
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px;
        }
        
        button:hover {
            background-color: #45a049;
        }

         .slider-container {
             width: 80%;
             margin: 0 auto 20px auto;
             display: flex;
             align-items: center;
         }

         .slider {
             -webkit-appearance: none;
             width: 100%;
             height: 10px;
             border-radius: 5px;
             background: #d3d3d3;
             outline: none;
             margin: 0 10px;
         }

         .slider::-webkit-slider-thumb {
             -webkit-appearance: none;
             appearance: none;
             width: 20px;
             height: 20px;
             border-radius: 50%;
             background: #4CAF50;
             cursor: pointer;
         }

         .slider::-moz-range-thumb {
             width: 20px;
             height: 20px;
             border-radius: 50%;
             background: #4CAF50;
             cursor: pointer;
         }
    </style>
</head>
<body>
    <h1>Pâques ou pas cap ?</h1>
    <div id="chart-container" class="chart-race-container">
        <div class="chart-title">Évolution du classement</div>
        <div class="riddle-display"></div>
        <div class="controls">
            <button id="play-pause">Pause</button>
            <button id="reset">Reset</button>
        </div>
        <div class="slider-container">
            <span id="slider-value">1</span>
            <input type="range" min="0" max="4" value="0" class="slider" id="riddle-slider">
            <span id="slider-max">25</span>
        </div>
        <div id="bar-chart"></div>
    </div>

    <script>
        // Colors for each team
        const colors = {
        };
        
        // Get unique riddles and entities
        const riddles = [...new Set(data.map(d => d.riddle))].sort(function(a, b) { return a - b; });
        const entities = [...new Set(data.map(d => d.team))];
        
        // Chart settings
        const margin = { top: 50, right: 120, bottom: 30, left: 120 };
        const width = 960 - margin.left - margin.right;
        const height = 1000 - margin.top - margin.bottom;
        const barHeight = 40;
        const barPadding = 10;
        const defaultDuration = 1500;
        const slideDuration = 0;
        const delay = 2000;
        
        // Get max score for scaling
        const maxValue = Math.max(...data.map(d => d.score)) * 1.1;
        
        // Create SVG
        const svg = d3.select("#bar-chart")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);
        
        // Create scales
        const xScale = d3.scaleLinear()
            .domain([0, maxValue])
            .range([0, width]);
        
        // Initialize animation variables
        let riddleIndex = 0;
        let timer;
        let isPlaying = true;
        
        function updateChart(duration) {
            const currentRiddle = riddles[riddleIndex];
            d3.select('.riddle-display').text(currentRiddle);
            
            // Get data for current riddle and sort by score
            const currentData = data
                .filter(d => d.riddle === currentRiddle)
                .sort((a, b) => b.score - a.score);
            
            const currentMaxValue = Math.max(...currentData.map(d => d.score)) * 1.1;

            const xScale = d3.scaleLinear()
            .domain([0, currentMaxValue])
            .range([0, width]);
            // Update y scale domain based on data
            const yScale = d3.scaleBand()
                .domain(currentData.map(d => d.team))
                .range([0, currentData.length * (barHeight + barPadding)])
                .padding(0.1);
            
            // JOIN data with elements
            const bars = svg.selectAll(".bar")
                .data(currentData, d => d.team);
            
            // EXIT old elements
            bars.exit()
                .transition()
                .duration(duration)
                .style("opacity", 0)
                .remove();
            
            // UPDATE existing elements
            bars.transition()
                .duration(duration)
                .attr("transform", d => `translate(0,${yScale(d.team)})`);
                
            bars.select("rect")
                .transition()
                .duration(duration)
                .attr("width", d => xScale(d.score));
            
            bars.select(".bar-score")
                .transition()
                .duration(duration)
                .attr("x", d => xScale(d.score) - 10)
                .text(d => d.score);
            
            // ENTER new elements
            const barsEnter = bars.enter()
                .append("g")
                .attr("class", "bar")
                .attr("transform", d => `translate(0,${yScale(d.team)})`)
                .style("opacity", 0);
            
            // Add rectangles to the enter selection
            barsEnter.append("rect")
                .attr("x", 0)
                .attr("width", 0)
                .attr("height", barHeight)
                .attr("fill", d => colors[d.team])
                .attr("rx", 4)
                .attr("ry", 4);
            
            // Add team name labels
            barsEnter.append("text")
                .attr("class", "bar-label")
                .attr("x", 10)
                .attr("y", barHeight / 2)
                .text(d => d.team);
            
            // Add score labels
            barsEnter.append("text")
                .attr("class", "bar-score")
                .attr("x", d => 0)
                .attr("y", barHeight / 2)
                .text(d => d.score);
            
            // Transition the enter selection
            barsEnter.transition()
                .duration(duration)
                .style("opacity", 1);
                
            barsEnter.select("rect")
                .transition()
                .duration(duration)
                .attr("width", d => xScale(d.score));
                
            barsEnter.select(".bar-score")
                .transition()
                .duration(duration)
                .attr("x", d => xScale(d.score) - 10);
            
            // Schedule next update
            if (isPlaying) {
                timer = setTimeout(() => {
                    riddleIndex = (riddleIndex + 1) % riddles.length;
                    // Update slider position to match current riddleIndex
                    d3.select("#riddle-slider").property("value", riddleIndex);
                    d3.select("#slider-value").text(riddles[riddleIndex]);
                    if (riddleIndex === 0) {
                        // Longer pause at the end of a cycle
                        setTimeout(function() {
                            updateChart(defaultDuration)
                        }, delay * 2);
                    } else {
                        updateChart(defaultDuration);
                    }
                }, delay);
            }
        }
        
        // Play/pause button
        d3.select("#play-pause").on("click", function() {
            isPlaying = !isPlaying;
            d3.select(this).text(isPlaying ? "Pause" : "Play");
            
            if (isPlaying) {
                updateChart(defaultDuration);
            } else {
                clearTimeout(timer);
            }
        });
        
        // Reset button
        d3.select("#reset").on("click", function() {
            riddleIndex = 0;
            d3.select("#riddle-slider").property("value", riddleIndex);
            clearTimeout(timer);
            updateChart(defaultDuration);
        });
        
        // Riddle slider
        d3.select("#riddle-slider")
            .property("max", riddles.length - 1)
            .on("input", function() {
                clearTimeout(timer);
                isPlaying = false;
                d3.select("#play-pause").text("Play");
                riddleIndex = +this.value;
                d3.select("#slider-value").text(riddles[riddleIndex]);
                updateChart(slideDuration);
            });
        // Initialize slider labels
        d3.select("#slider-value").text(riddles[0]);
        d3.select("#slider-max").text(riddles[riddles.length - 1]);
        
        // Start the animation
        updateChart(defaultDuration);
    </script>
</body>
</html>