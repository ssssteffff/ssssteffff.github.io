<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bar Chart Race Animation</title>
    <!-- Add D3.js library -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .chart-race-container {
            margin: 20px auto;
            max-width: 960px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            padding: 20px;
            position: relative;
        }
        
        .chart-title {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }
        
        .date-display {
            font-size: 28px;
            font-weight: bold;
            opacity: 0.7;
            position: absolute;
            top: 20px;
            right: 30px;
            color: #555;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }
        
        .bar-label {
            font-weight: bold;
            fill: white;
            text-shadow: 1px 1px 1px rgba(0,0,0,0.5);
            dominant-baseline: middle;
        }
        
        .bar-value {
            font-weight: bold;
            fill: white;
            text-shadow: 1px 1px 1px rgba(0,0,0,0.5);
            text-anchor: end;
            dominant-baseline: middle;
        }
        
        .controls {
            text-align: center;
            margin-top: 20px;
        }
        
        button {
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px;
        }
        
        button:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>
    <h1>Tech Companies Market Cap</h1>
    <div id="chart-container" class="chart-race-container">
        <div class="chart-title">Top Tech Companies by Market Cap (in Billions USD)</div>
        <div class="date-display"></div>
        <div id="bar-chart"></div>
        <div class="controls">
            <button id="play-pause">Pause</button>
            <button id="reset">Reset</button>
        </div>
    </div>

    <script>
        // Sample data for the chart race
        let response = await fetch('./enigmes.json')
                        .then(function(response) {
                            return response.json();
                        });

        const data = await response.json();
        /*[
            // Date 1
            { name: 'Apple', value: 100, date: '2020-01' },
            { name: 'Google', value: 80, date: '2020-01' },
            { name: 'Microsoft', value: 70, date: '2020-01' },
            { name: 'Amazon', value: 60, date: '2020-01' },
            { name: 'Facebook', value: 50, date: '2020-01' },
            
            // Date 2
            { name: 'Apple', value: 110, date: '2020-02' },
            { name: 'Google', value: 95, date: '2020-02' },
            { name: 'Microsoft', value: 85, date: '2020-02' },
            { name: 'Amazon', value: 75, date: '2020-02' },
            { name: 'Facebook', value: 65, date: '2020-02' },
            
            // Date 3
            { name: 'Apple', value: 130, date: '2020-03' },
            { name: 'Google', value: 105, date: '2020-03' },
            { name: 'Microsoft', value: 100, date: '2020-03' },
            { name: 'Amazon', value: 95, date: '2020-03' },
            { name: 'Facebook', value: 75, date: '2020-03' },
            
            // Date 4
            { name: 'Apple', value: 140, date: '2020-04' },
            { name: 'Amazon', value: 125, date: '2020-04' },
            { name: 'Google', value: 115, date: '2020-04' },
            { name: 'Microsoft', value: 110, date: '2020-04' },
            { name: 'Facebook', value: 90, date: '2020-04' },
            
            // Date 5
            { name: 'Amazon', value: 150, date: '2020-05' },
            { name: 'Apple', value: 145, date: '2020-05' },
            { name: 'Google', value: 125, date: '2020-05' },
            { name: 'Microsoft', value: 120, date: '2020-05' },
            { name: 'Facebook', value: 100, date: '2020-05' },
        ];*/

        // Format values with dollar sign and commas
        const formatValue = (value) => `$${value.toLocaleString()}B`;

        // Colors for each company
        const colors = {
            'Apple': '#FF6384',
            'Google': '#36A2EB',
            'Microsoft': '#FFCE56',
            'Amazon': '#4BC0C0',
            'Facebook': '#9966FF'
        };
        
        // Get unique dates and entities
        const dates = [...new Set(data.map(d => d.date))].sort();
        const entities = [...new Set(data.map(d => d.name))];
        
        // Chart settings
        const margin = { top: 50, right: 120, bottom: 30, left: 120 };
        const width = 960 - margin.left - margin.right;
        const height = 500 - margin.top - margin.bottom;
        const barHeight = 40;
        const barPadding = 10;
        const duration = 750;
        const delay = 1000;
        
        // Get max value for scaling
        const maxValue = Math.max(...data.map(d => d.value)) * 1.1;
        
        // Create SVG
        const svg = d3.select("#bar-chart")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);
        
        // Create scales
        const xScale = d3.scaleLinear()
            .domain([0, maxValue])
            .range([0, width]);
        
        // Initialize animation variables
        let dateIndex = 0;
        let timer;
        let isPlaying = true;
        
        function updateChart() {
            const currentDate = dates[dateIndex];
            d3.select('.date-display').text(currentDate);
            
            // Get data for current date and sort by value
            const currentData = data
                .filter(d => d.date === currentDate)
                .sort((a, b) => b.value - a.value);
            
            // Update y scale domain based on data
            const yScale = d3.scaleBand()
                .domain(currentData.map(d => d.name))
                .range([0, currentData.length * (barHeight + barPadding)])
                .padding(0.1);
            
            // JOIN data with elements
            const bars = svg.selectAll(".bar")
                .data(currentData, d => d.name);
            
            // EXIT old elements
            bars.exit()
                .transition()
                .duration(duration)
                .style("opacity", 0)
                .remove();
            
            // UPDATE existing elements
            bars.transition()
                .duration(duration)
                .attr("transform", d => `translate(0,${yScale(d.name)})`);
                
            bars.select("rect")
                .transition()
                .duration(duration)
                .attr("width", d => xScale(d.value));
            
            bars.select(".bar-value")
                .transition()
                .duration(duration)
                .attr("x", d => xScale(d.value) - 10)
                .text(d => formatValue(d.value));
            
            // ENTER new elements
            const barsEnter = bars.enter()
                .append("g")
                .attr("class", "bar")
                .attr("transform", d => `translate(0,${yScale(d.name)})`)
                .style("opacity", 0);
            
            // Add rectangles to the enter selection
            barsEnter.append("rect")
                .attr("x", 0)
                .attr("width", 0)
                .attr("height", barHeight)
                .attr("fill", d => colors[d.name])
                .attr("rx", 4)
                .attr("ry", 4);
            
            // Add company name labels
            barsEnter.append("text")
                .attr("class", "bar-label")
                .attr("x", 10)
                .attr("y", barHeight / 2)
                .text(d => d.name);
            
            // Add value labels
            barsEnter.append("text")
                .attr("class", "bar-value")
                .attr("x", d => 0)
                .attr("y", barHeight / 2)
                .text(d => formatValue(d.value));
            
            // Transition the enter selection
            barsEnter.transition()
                .duration(duration)
                .style("opacity", 1);
                
            barsEnter.select("rect")
                .transition()
                .duration(duration)
                .attr("width", d => xScale(d.value));
                
            barsEnter.select(".bar-value")
                .transition()
                .duration(duration)
                .attr("x", d => xScale(d.value) - 10);
            
            // Schedule next update
            if (isPlaying) {
                timer = setTimeout(() => {
                    dateIndex = (dateIndex + 1) % dates.length;
                    if (dateIndex === 0) {
                        // Longer pause at the end of a cycle
                        setTimeout(updateChart, delay * 2);
                    } else {
                        updateChart();
                    }
                }, delay);
            }
        }
        
        // Play/pause button
        d3.select("#play-pause").on("click", function() {
            isPlaying = !isPlaying;
            d3.select(this).text(isPlaying ? "Pause" : "Play");
            
            if (isPlaying) {
                updateChart();
            } else {
                clearTimeout(timer);
            }
        });
        
        // Reset button
        d3.select("#reset").on("click", function() {
            dateIndex = 0;
            clearTimeout(timer);
            updateChart();
        });
        
        // Start the animation
        updateChart();
    </script>
</body>
</html>